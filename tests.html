<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workout Tracker — Tests</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, sans-serif; background: #0a0a0a; color: #fff; padding: 20px; max-width: 700px; margin: 0 auto; }
    h1 { margin-bottom: 16px; }
    h2 { margin: 20px 0 8px; color: #8B5CF6; font-size: 16px; }
    .pass { color: #22c55e; }
    .fail { color: #ef4444; }
    .result { padding: 4px 0; font-size: 14px; font-family: monospace; }
    #summary { margin-top: 20px; padding: 12px; border-radius: 8px; font-weight: 700; font-size: 16px; }
    #summary.all-pass { background: rgba(34,197,94,0.15); color: #22c55e; }
    #summary.has-fail { background: rgba(239,68,68,0.15); color: #ef4444; }
  </style>
</head>
<body>
  <h1>Workout Tracker Tests</h1>
  <div id="app" style="display:none"></div>
  <div id="results"></div>
  <div id="summary"></div>

  <!-- Load app scripts in order -->
  <script src="js/data.js"></script>
  <script src="js/strength-standards.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/components/set-table.js"></script>
  <script src="js/components/data-modal.js"></script>
  <script src="js/components/streak.js"></script>
  <script src="js/components/strength-score.js"></script>
  <script src="js/components/progress-chart.js"></script>
  <script src="js/views/home.js"></script>
  <script src="js/views/workout.js"></script>
  <script src="js/views/log-exercise.js"></script>
  <script src="js/views/history.js"></script>
  <script src="js/views/calendar.js"></script>
  <script src="js/views/progress.js"></script>
  <script src="js/views/settings.js"></script>
  <script src="js/views/template-builder.js"></script>
  <script src="js/app.js"></script>

  <script>
    const resultsEl = document.getElementById('results');
    let passed = 0, failed = 0;

    function assert(condition, label) {
      if (condition) {
        passed++;
        resultsEl.innerHTML += `<div class="result pass">  ✓ ${label}</div>`;
      } else {
        failed++;
        resultsEl.innerHTML += `<div class="result fail">  ✗ ${label}</div>`;
      }
    }

    function section(name) {
      resultsEl.innerHTML += `<h2>${name}</h2>`;
    }

    // ── Seed test data ──────────────────────────────────────────────
    function seedData() {
      localStorage.clear();
      const logs = [
        {
          id: 'log1',
          templateId: 'day1',
          date: '2026-02-10T18:00:00.000Z',
          exercises: [
            {
              exerciseId: 'squat',
              sets: [
                { reps: 8, weight: 225, done: true },
                { reps: 8, weight: 225, done: true },
                { reps: 6, weight: 235, done: true }
              ],
              note: 'Felt strong'
            },
            {
              exerciseId: 'rdl',
              sets: [
                { reps: 10, weight: 185, done: true },
                { reps: 10, weight: 185, done: true }
              ],
              note: ''
            }
          ]
        },
        {
          id: 'log2',
          templateId: 'day2',
          date: '2026-02-12T19:30:00.000Z',
          exercises: [
            {
              exerciseId: 'ohp',
              sets: [
                { reps: 8, weight: 135, done: true },
                { reps: 7, weight: 135, done: true }
              ],
              note: ''
            },
            {
              exerciseId: 'ng_chinup',
              sets: [
                { reps: 8, weight: 0, done: true },
                { reps: 7, weight: 0, done: true },
                { reps: 6, weight: 0, done: true }
              ],
              note: 'Bodyweight only'
            }
          ]
        },
        {
          id: 'log3',
          templateId: 'day1',
          date: '2026-02-10T20:00:00.000Z',
          exercises: [
            {
              exerciseId: 'squat',
              sets: [
                { reps: 5, weight: 245, done: true }
              ],
              note: ''
            }
          ]
        },
        {
          id: 'log4',
          templateId: 'day1',
          date: '2026-01-15T17:00:00.000Z',
          exercises: [
            {
              exerciseId: 'squat',
              sets: [
                { reps: 8, weight: 205, done: true },
                { reps: 8, weight: 205, done: true }
              ],
              note: ''
            }
          ]
        },
        {
          id: 'log5',
          templateId: 'day4',
          date: '2026-02-14T23:00:00.000Z',
          exercises: [
            {
              exerciseId: 'ng_chinup',
              sets: [
                { reps: 10, weight: 0, done: true },
                { reps: 9, weight: 0, done: true }
              ],
              note: ''
            },
            {
              exerciseId: 'box_jump',
              sets: [],
              note: ''
            }
          ]
        }
      ];
      localStorage.setItem('workout_logs', JSON.stringify(logs));
    }

    // ── Run tests ───────────────────────────────────────────────────
    seedData();

    // ═══════════════════════════════════════════════════════════════
    section('Storage: getLogsByMonth');
    // ═══════════════════════════════════════════════════════════════
    {
      const febLogs = Storage.getLogsByMonth(2026, 1);
      assert(febLogs.length === 4, `Feb 2026 has 4 logs (got ${febLogs.length})`);

      const janLogs = Storage.getLogsByMonth(2026, 0);
      assert(janLogs.length === 1, `Jan 2026 has 1 log (got ${janLogs.length})`);

      const marLogs = Storage.getLogsByMonth(2026, 2);
      assert(marLogs.length === 0, `Mar 2026 has 0 logs (got ${marLogs.length})`);

      const wrongYear = Storage.getLogsByMonth(2025, 1);
      assert(wrongYear.length === 0, `Feb 2025 has 0 logs (got ${wrongYear.length})`);
    }

    // ═══════════════════════════════════════════════════════════════
    section('Storage: getLogsByDate');
    // ═══════════════════════════════════════════════════════════════
    {
      const feb10 = Storage.getLogsByDate('2026-02-10');
      assert(feb10.length === 2, `Feb 10 has 2 logs — multiple workouts same day (got ${feb10.length})`);

      const feb12 = Storage.getLogsByDate('2026-02-12');
      assert(feb12.length === 1, `Feb 12 has 1 log (got ${feb12.length})`);

      const feb13 = Storage.getLogsByDate('2026-02-13');
      assert(feb13.length === 0, `Feb 13 has 0 logs (got ${feb13.length})`);

      const log5Date = new Date('2026-02-14T23:00:00.000Z');
      const localDay = log5Date.getDate();
      const localMonth = String(log5Date.getMonth() + 1).padStart(2, '0');
      const localYear = log5Date.getFullYear();
      const localDateStr = `${localYear}-${localMonth}-${String(localDay).padStart(2, '0')}`;
      const tzLogs = Storage.getLogsByDate(localDateStr);
      assert(tzLogs.some(l => l.id === 'log5'),
        `log5 (Feb 14 23:00 UTC) found when searching local date ${localDateStr}`);
    }

    // ═══════════════════════════════════════════════════════════════
    section('Storage: getExerciseHistory');
    // ═══════════════════════════════════════════════════════════════
    {
      const squatHist = Storage.getExerciseHistory('squat');
      assert(squatHist.length === 3, `Squat has 3 sessions (got ${squatHist.length})`);

      const dates = squatHist.map(h => new Date(h.date).getTime());
      const isSorted = dates.every((d, i) => i === 0 || d >= dates[i - 1]);
      assert(isSorted, 'Squat history sorted by date ascending');

      const log1Entry = squatHist.find(h => h.date === '2026-02-10T18:00:00.000Z');
      assert(log1Entry && log1Entry.maxWeight === 235, `log1 squat maxWeight=235 (got ${log1Entry?.maxWeight})`);
      assert(log1Entry && log1Entry.totalVolume === 5010, `log1 squat totalVolume=5010 (got ${log1Entry?.totalVolume})`);
      assert(log1Entry && log1Entry.maxReps === 8, `log1 squat maxReps=8 (got ${log1Entry?.maxReps})`);

      const chinupHist = Storage.getExerciseHistory('ng_chinup');
      assert(chinupHist.length === 2, `Chin-ups have 2 sessions (got ${chinupHist.length})`);
      assert(chinupHist.every(h => h.maxWeight === 0), 'Chin-ups all maxWeight=0 (bodyweight)');
      assert(chinupHist[1].maxReps === 10, `Chin-up session 2 maxReps=10 (got ${chinupHist[1]?.maxReps})`);

      const noHist = Storage.getExerciseHistory('nonexistent');
      assert(noHist.length === 0, 'Non-existent exercise returns empty array');

      const boxJumpHist = Storage.getExerciseHistory('box_jump');
      assert(boxJumpHist.length === 0, 'box_jump with empty sets excluded from history');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Calendar: formatVolume');
    // ═══════════════════════════════════════════════════════════════
    {
      assert(formatVolume(0) === '0', `formatVolume(0) = "0" (got "${formatVolume(0)}")`);
      assert(formatVolume(500) === '500', `formatVolume(500) = "500" (got "${formatVolume(500)}")`);
      assert(formatVolume(1000) === '1k', `formatVolume(1000) = "1k" (got "${formatVolume(1000)}")`);
      assert(formatVolume(1500) === '1.5k', `formatVolume(1500) = "1.5k" (got "${formatVolume(1500)}")`);
      assert(formatVolume(45200) === '45.2k', `formatVolume(45200) = "45.2k" (got "${formatVolume(45200)}")`);
      assert(formatVolume(10000) === '10k', `formatVolume(10000) = "10k" (got "${formatVolume(10000)}")`);
    }

    // ═══════════════════════════════════════════════════════════════
    section('Calendar: buildCalendarRows');
    // ═══════════════════════════════════════════════════════════════
    {
      const activeDays = new Set([10, 12, 14]);
      const today = new Date(2026, 1, 15);
      const html = buildCalendarRows(2026, 1, activeDays, today);

      assert(html.includes('cal-header'), 'Calendar has header row');
      assert(html.includes('Sun') && html.includes('Sat'), 'Header has day names');
      assert(html.includes('data-date="2026-02-01"'), 'Feb 1 present');
      assert(html.includes('data-date="2026-02-28"'), 'Feb 28 present');
      assert(!html.includes('data-date="2026-02-29"'), 'No Feb 29 (non-leap year)');
      assert(html.includes('data-date="2026-02-10"') && html.includes('cal-dot'), 'Day 10 has workout dot');

      const todayMatch = html.match(/class="[^"]*today[^"]*"[^>]*data-date="2026-02-15"/);
      assert(todayMatch, 'Feb 15 has today class');

      const day3Section = html.match(/data-date="2026-02-03"[\s\S]*?<\/div>/);
      assert(day3Section && !day3Section[0].includes('cal-dot'), 'Day 3 (no workout) has no dot');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Calendar: renderCalendar — DOM integration');
    // ═══════════════════════════════════════════════════════════════
    {
      renderCalendar(2026, 1);
      const app = document.getElementById('app');

      const statValues = app.querySelectorAll('.stat-value');
      assert(statValues.length === 4, `Has 4 stat values (got ${statValues.length})`);
      assert(statValues[0].textContent.trim() === '4', `Workouts count = 4 (got "${statValues[0].textContent.trim()}")`);

      const monthLabel = app.querySelector('.month-nav-label');
      assert(monthLabel && monthLabel.textContent.includes('February') && monthLabel.textContent.includes('2026'),
        `Month label shows "February 2026" (got "${monthLabel?.textContent}")`);

      const activeCells = app.querySelectorAll('.cal-day.active');
      assert(activeCells.length > 0, 'Some calendar days are marked active');

      const day10 = app.querySelector('.cal-day[data-date="2026-02-10"]');
      assert(day10 !== null, 'Day 10 cell exists');

      const stats = document.getElementById('summary-stats');
      const toggle = document.getElementById('summary-toggle');
      toggle.click();
      assert(stats.style.display === 'none', 'Summary collapses on click');
      toggle.click();
      assert(stats.style.display !== 'none', 'Summary expands on second click');

      assert(document.getElementById('prev-month') !== null, 'Prev month button exists');
      assert(document.getElementById('next-month') !== null, 'Next month button exists');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Calendar: renderCalendar — empty month');
    // ═══════════════════════════════════════════════════════════════
    {
      renderCalendar(2026, 2);
      const app = document.getElementById('app');
      const statValues = app.querySelectorAll('.stat-value');
      assert(statValues[0].textContent.trim() === '0', 'Empty month shows 0 workouts');
      assert(app.querySelectorAll('.cal-day.active').length === 0, 'No active days in empty month');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Calendar: renderCalendarDay — with data');
    // ═══════════════════════════════════════════════════════════════
    {
      renderCalendarDay('2026-02-10');
      const app = document.getElementById('app');

      const exerciseBlocks = app.querySelectorAll('.history-exercise');
      assert(exerciseBlocks.length >= 2, `Feb 10 has ≥2 exercise blocks (got ${exerciseBlocks.length})`);

      const clickables = app.querySelectorAll('.clickable-exercise');
      assert(clickables.length >= 2, `Clickable exercises exist (got ${clickables.length})`);
      assert(clickables[0].dataset.exerciseId, 'Clickable exercise has data-exercise-id');

      const progressLinks = app.querySelectorAll('.progress-link');
      assert(progressLinks.length >= 2, `Progress links present (got ${progressLinks.length})`);

      assert(app.innerHTML.includes('reps'), 'Set lines show reps');
      assert(app.innerHTML.includes('Felt strong'), 'Exercise notes are displayed');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Calendar: renderCalendarDay — empty day');
    // ═══════════════════════════════════════════════════════════════
    {
      renderCalendarDay('2026-02-13');
      const app = document.getElementById('app');
      assert(app.innerHTML.includes('No workouts on this day'), 'Empty day shows message');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Progress: renderProgress — weighted exercise');
    // ═══════════════════════════════════════════════════════════════
    {
      renderProgress('squat');
      const app = document.getElementById('app');

      assert(app.innerHTML.includes('Back Squat'), 'Shows exercise name');
      assert(app.innerHTML.includes('Progress'), 'Shows "Progress" subtitle');

      const statItems = app.querySelectorAll('.progress-summary .stat-item');
      assert(statItems.length === 3, `3 summary stats (got ${statItems.length})`);

      const latestText = statItems[0].querySelector('.stat-value').textContent.trim();
      assert(latestText.includes('245'), `Latest = 245 lbs (got "${latestText}")`);

      const bestText = statItems[1].querySelector('.stat-value').textContent.trim();
      assert(bestText.includes('245'), `Best = 245 lbs (got "${bestText}")`);

      const sessionsText = statItems[2].querySelector('.stat-value').textContent.trim();
      assert(sessionsText === '3', `Sessions = 3 (got "${sessionsText}")`);

      assert(latestText.includes('lbs'), 'Uses "lbs" unit for weighted exercise');

      const chartContainer = document.getElementById('chart-container');
      assert(chartContainer !== null, 'Chart container exists');
      const chart = chartContainer.querySelector('.progress-chart');
      assert(chart !== null, 'Progress chart rendered');
      assert(chart.querySelector('canvas') !== null, 'Chart has canvas element');

      const sessions = app.querySelectorAll('.progress-session');
      assert(sessions.length === 3, `3 recent sessions listed (got ${sessions.length})`);

      const firstSessionSets = sessions[0].querySelector('.progress-session-sets').textContent;
      assert(firstSessionSets.includes('×'), 'Set breakdown uses "reps×weight" format');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Progress: renderProgress — bodyweight exercise');
    // ═══════════════════════════════════════════════════════════════
    {
      renderProgress('ng_chinup');
      const app = document.getElementById('app');

      const statItems = app.querySelectorAll('.progress-summary .stat-item');
      const latestText = statItems[0].querySelector('.stat-value').textContent.trim();
      assert(latestText.includes('reps'), 'Bodyweight uses "reps" unit');
      assert(latestText.includes('10'), `Latest = 10 reps (got "${latestText}")`);

      const bestText = statItems[1].querySelector('.stat-value').textContent.trim();
      assert(bestText.includes('10'), `Best = 10 reps (got "${bestText}")`);

      const sessionSets = app.querySelector('.progress-session-sets').textContent;
      assert(sessionSets.includes('reps'), 'Bodyweight sessions show "reps" format');
      assert(!sessionSets.includes('×'), 'Bodyweight sessions do not use × format');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Progress: renderProgress — empty exercise');
    // ═══════════════════════════════════════════════════════════════
    {
      renderProgress('box_jump');
      const app = document.getElementById('app');
      assert(app.innerHTML.includes('No data yet'), 'Empty exercise shows no-data message');
      assert(app.querySelectorAll('.progress-summary').length === 0, 'No summary for empty exercise');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Progress: renderProgress — unknown exercise');
    // ═══════════════════════════════════════════════════════════════
    {
      renderProgress('nonexistent_exercise');
      const app = document.getElementById('app');
      assert(app.innerHTML.includes('No data yet'), 'Unknown exercise shows empty state');
      assert(app.innerHTML.includes('nonexistent_exercise'), 'Falls back to exerciseId as name');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Chart: createProgressChart');
    // ═══════════════════════════════════════════════════════════════
    {
      const emptyChart = createProgressChart([], 'lbs');
      assert(emptyChart.innerHTML.includes('No data to chart'), 'Empty chart shows message');

      const nullChart = createProgressChart(null, 'lbs');
      assert(nullChart.innerHTML.includes('No data to chart'), 'Null data shows message');

      const singleChart = createProgressChart([{ date: '2026-02-10T18:00:00Z', value: 225 }], 'lbs');
      assert(singleChart.querySelector('canvas') !== null, 'Single point chart has canvas');
      assert(singleChart.querySelector('.chart-tooltip') !== null, 'Chart has tooltip element');

      const multiChart = createProgressChart([
        { date: '2026-01-15T17:00:00Z', value: 205 },
        { date: '2026-02-10T18:00:00Z', value: 235 },
        { date: '2026-02-10T20:00:00Z', value: 245 }
      ], 'lbs');
      assert(multiChart.querySelector('canvas') !== null, 'Multi-point chart has canvas');

      const flatChart = createProgressChart([
        { date: '2026-01-01T00:00:00Z', value: 100 },
        { date: '2026-02-01T00:00:00Z', value: 100 },
      ], 'lbs');
      assert(flatChart.querySelector('canvas') !== null, 'Flat-line chart renders without error');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Routing');
    // ═══════════════════════════════════════════════════════════════
    {
      const origHash = window.location.hash;
      let threw = false;

      try {
        window.location.hash = '#calendar';
        route();
      } catch (e) { threw = true; }
      assert(!threw, '#calendar route does not throw');

      threw = false;
      try {
        window.location.hash = '#calendar/2026-02-10';
        route();
      } catch (e) { threw = true; }
      assert(!threw, '#calendar/YYYY-MM-DD route does not throw');

      threw = false;
      try {
        window.location.hash = '#progress/squat';
        route();
      } catch (e) { threw = true; }
      assert(!threw, '#progress/exerciseId route does not throw');

      window.location.hash = origHash;
    }

    // ═══════════════════════════════════════════════════════════════
    section('Home: calendar button');
    // ═══════════════════════════════════════════════════════════════
    {
      renderHome();
      const app = document.getElementById('app');
      const calBtn = document.getElementById('calendar-btn');
      assert(calBtn !== null, 'Calendar button exists on home page');
      assert(calBtn.querySelector('svg') !== null, 'Calendar button has SVG icon');

      const histBtn = document.getElementById('history-btn');
      const dataBtn = document.getElementById('data-btn');
      assert(histBtn !== null, 'History button still exists');
      assert(dataBtn !== null, 'Data/settings button still exists');
    }

    // ═══════════════════════════════════════════════════════════════
    section('History: clickable exercises in detail');
    // ═══════════════════════════════════════════════════════════════
    {
      renderHistoryDetail('log1');
      const app = document.getElementById('app');
      const clickables = app.querySelectorAll('.clickable-exercise');
      assert(clickables.length >= 2, `History detail has clickable exercises (got ${clickables.length})`);

      const squatLink = app.querySelector('.clickable-exercise[data-exercise-id="squat"]');
      assert(squatLink !== null, 'Squat exercise is clickable with correct data attribute');
      assert(squatLink.querySelector('.progress-link') !== null, 'Has progress indicator');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Calendar grid: edge cases');
    // ═══════════════════════════════════════════════════════════════
    {
      const marchHtml = buildCalendarRows(2026, 2, new Set(), new Date(2026, 2, 1));
      assert(marchHtml.includes('data-date="2026-03-01"'), 'March 1 present');
      assert(marchHtml.includes('data-date="2026-03-31"'), 'March 31 present');

      const aprilHtml = buildCalendarRows(2026, 3, new Set(), new Date(2026, 3, 15));
      assert(aprilHtml.includes('empty'), 'April has empty leading cells');
      assert(aprilHtml.includes('data-date="2026-04-01"'), 'April 1 present');
      assert(aprilHtml.includes('data-date="2026-04-30"'), 'April 30 present');
      assert(!aprilHtml.includes('data-date="2026-04-31"'), 'No April 31');

      const feb2024Html = buildCalendarRows(2024, 1, new Set(), new Date(2024, 1, 15));
      assert(feb2024Html.includes('data-date="2024-02-29"'), 'Leap year Feb 29 present');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Service worker: new files loaded');
    // ═══════════════════════════════════════════════════════════════
    {
      assert(typeof createProgressChart === 'function', 'progress-chart.js loaded');
      assert(typeof renderCalendar === 'function', 'calendar.js loaded');
      assert(typeof renderCalendarDay === 'function', 'calendar.js renderCalendarDay loaded');
      assert(typeof renderProgress === 'function', 'progress.js loaded');
      assert(typeof buildCalendarRows === 'function', 'buildCalendarRows exported');
      assert(typeof formatVolume === 'function', 'formatVolume exported');
      assert(typeof computeStrengthScore === 'function', 'strength-score.js loaded');
      assert(typeof createStrengthScoreCard === 'function', 'createStrengthScoreCard loaded');
      assert(typeof computeStreaks === 'function', 'streak.js loaded');
      assert(typeof renderSettings === 'function', 'settings.js loaded');
      assert(typeof renderTemplateBuilder === 'function', 'template-builder.js loaded');
      assert(typeof playTimerBeep === 'function', 'playTimerBeep loaded');
      assert(typeof getAllTemplates === 'function', 'getAllTemplates loaded');
    }

    // ═══════════════════════════════════════════════════════════════
    // Phase 4 Tests: Storage — bodyweight/gender
    // ═══════════════════════════════════════════════════════════════
    section('Phase 4: Storage — bodyweight/gender');
    {
      localStorage.clear();
      assert(Storage.getBodyweight() === null, 'Default bodyweight is null');
      assert(Storage.getGender() === 'male', 'Default gender is male');

      Storage.setBodyweight(185);
      assert(Storage.getBodyweight() === 185, 'setBodyweight(185) persists');

      Storage.setGender('female');
      assert(Storage.getGender() === 'female', 'setGender(female) persists');

      // Export includes bodyweight/gender
      const exported = Storage.exportAll();
      assert(exported.bodyweight === 185, 'exportAll includes bodyweight');
      assert(exported.gender === 'female', 'exportAll includes gender');

      // Import preserves them
      localStorage.clear();
      Storage.importData(exported, 'replace');
      assert(Storage.getBodyweight() === 185, 'importData replace preserves bodyweight');
      assert(Storage.getGender() === 'female', 'importData replace preserves gender');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Phase 4: Wathan formula');
    // ═══════════════════════════════════════════════════════════════
    {
      // 1RM of a 1-rep max should be the weight itself
      const oneRep = wathanEstimate1RM(225, 1);
      assert(oneRep === 225, `1RM of 225x1 = 225 (got ${oneRep})`);

      // 0 reps = 0
      assert(wathanEstimate1RM(225, 0) === 0, 'wathanEstimate1RM(225, 0) = 0');

      // Known approximate: 225 x 5 ≈ 253 (Wathan)
      const fiveRep = Math.round(wathanEstimate1RM(225, 5));
      assert(fiveRep >= 248 && fiveRep <= 258, `225x5 ≈ 253 (got ${fiveRep})`);

      // 8 reps should give higher 1RM estimate
      const eightRep = wathanEstimate1RM(225, 8);
      assert(eightRep > wathanEstimate1RM(225, 5), '8-rep estimate > 5-rep for same weight');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Phase 4: Strength score computation');
    // ═══════════════════════════════════════════════════════════════
    {
      // No bodyweight = no data
      localStorage.clear();
      const noData = computeStrengthScore();
      assert(noData.hasData === false, 'No bodyweight → hasData=false');
      assert(noData.overallScore === 0, 'No bodyweight → score=0');

      // With bodyweight + seeded logs
      seedData();
      Storage.setBodyweight(180);
      Storage.setGender('male');

      const score = computeStrengthScore();
      assert(score.hasData === true, 'With workout data → hasData=true');
      assert(score.bodyweight === 180, 'bodyweight=180');
      assert(score.categories.length === 5, '5 strength categories');
      assert(score.overallScore > 0, `overallScore > 0 (got ${score.overallScore})`);
      assert(score.overallScore <= 100, `overallScore <= 100 (got ${score.overallScore})`);

      // Squat category should have data
      const squatCat = score.categories.find(c => c.id === 'squat');
      assert(squatCat.estimated1RM > 0, `Squat 1RM > 0 (got ${squatCat.estimated1RM})`);
      assert(squatCat.bwRatio > 0, `Squat BW ratio > 0 (got ${squatCat.bwRatio})`);
      assert(STRENGTH_LEVELS.includes(squatCat.level), `Squat level is valid (got ${squatCat.level})`);

      // Pullup category — bodyweight exercise
      const pullupCat = score.categories.find(c => c.id === 'pullup');
      assert(pullupCat.estimated1RM > 0, `Pullup 1RM > 0 (got ${pullupCat.estimated1RM})`);

      // Female thresholds should produce different level for same data
      Storage.setGender('female');
      const femaleScore = computeStrengthScore();
      Storage.setGender('male');
      // Female thresholds are lower, so score should be higher or equal
      assert(femaleScore.overallScore >= score.overallScore, 'Female thresholds → higher or equal score');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Phase 4: Settings DOM');
    // ═══════════════════════════════════════════════════════════════
    {
      seedData();
      Storage.setBodyweight(180);
      Storage.setGender('male');

      renderSettings();
      const app = document.getElementById('app');

      assert(document.getElementById('bodyweight-input') !== null, 'Bodyweight input exists');
      assert(document.getElementById('gender-male') !== null, 'Gender male toggle exists');
      assert(document.getElementById('gender-female') !== null, 'Gender female toggle exists');
      assert(document.getElementById('export-btn') !== null, 'Export button exists');
      assert(document.getElementById('import-file') !== null, 'Import file input exists');

      // Strength score detail should be rendered
      const strengthContainer = document.getElementById('strength-detail-container');
      assert(strengthContainer !== null, 'Strength detail container exists');
      assert(strengthContainer.querySelector('.strength-detail') !== null, 'Strength detail card rendered');
    }

    // ═══════════════════════════════════════════════════════════════
    section('Phase 4: Settings route');
    // ═══════════════════════════════════════════════════════════════
    {
      const origHash = window.location.hash;
      let threw = false;
      try {
        window.location.hash = '#settings';
        route();
      } catch (e) { threw = true; }
      assert(!threw, '#settings route does not throw');
      window.location.hash = origHash;
    }

    // ═══════════════════════════════════════════════════════════════
    // Phase 6 Tests: Streaks
    // ═══════════════════════════════════════════════════════════════
    section('Phase 6: Streaks — empty logs');
    {
      localStorage.clear();
      const empty = computeStreaks();
      assert(empty.currentStreak === 0, 'Empty → currentStreak=0');
      assert(empty.longestStreak === 0, 'Empty → longestStreak=0');
      assert(empty.thisWeekCount === 0, 'Empty → thisWeekCount=0');
    }

    section('Phase 6: Streaks — with data');
    {
      // Create logs across multiple weeks
      localStorage.clear();
      const now = new Date();
      const thisMonday = new Date(now);
      const day = thisMonday.getDay();
      const diff = day === 0 ? 6 : day - 1;
      thisMonday.setDate(thisMonday.getDate() - diff);
      thisMonday.setHours(12, 0, 0, 0);

      const logs = [
        // This week — 2 workouts
        { id: 'streak1', templateId: 'day1', date: thisMonday.toISOString(), exercises: [{ exerciseId: 'squat', sets: [{ reps: 5, weight: 225 }] }] },
        { id: 'streak2', templateId: 'day2', date: new Date(thisMonday.getTime() + 2 * 86400000).toISOString(), exercises: [{ exerciseId: 'ohp', sets: [{ reps: 5, weight: 135 }] }] },
        // Last week
        { id: 'streak3', templateId: 'day1', date: new Date(thisMonday.getTime() - 5 * 86400000).toISOString(), exercises: [{ exerciseId: 'squat', sets: [{ reps: 5, weight: 225 }] }] },
        // 2 weeks ago
        { id: 'streak4', templateId: 'day3', date: new Date(thisMonday.getTime() - 10 * 86400000).toISOString(), exercises: [{ exerciseId: 'rdl', sets: [{ reps: 5, weight: 185 }] }] },
      ];
      localStorage.setItem('workout_logs', JSON.stringify(logs));

      const streaks = computeStreaks();
      assert(streaks.currentStreak === 3, `3 consecutive weeks → currentStreak=3 (got ${streaks.currentStreak})`);
      assert(streaks.longestStreak === 3, `longestStreak=3 (got ${streaks.longestStreak})`);
      assert(streaks.thisWeekCount === 2, `thisWeekCount=2 (got ${streaks.thisWeekCount})`);
    }

    section('Phase 6: Streaks — gap breaks streak');
    {
      localStorage.clear();
      const now = new Date();
      const thisMonday = new Date(now);
      const day = thisMonday.getDay();
      const mondayDiff = day === 0 ? 6 : day - 1;
      thisMonday.setDate(thisMonday.getDate() - mondayDiff);
      thisMonday.setHours(12, 0, 0, 0);

      const logs = [
        // This week
        { id: 'g1', templateId: 'day1', date: thisMonday.toISOString(), exercises: [{ exerciseId: 'squat', sets: [{ reps: 5, weight: 225 }] }] },
        // Skip last week — gap!
        // 2 weeks ago
        { id: 'g2', templateId: 'day1', date: new Date(thisMonday.getTime() - 14 * 86400000).toISOString(), exercises: [{ exerciseId: 'squat', sets: [{ reps: 5, weight: 225 }] }] },
        // 3 weeks ago
        { id: 'g3', templateId: 'day1', date: new Date(thisMonday.getTime() - 21 * 86400000).toISOString(), exercises: [{ exerciseId: 'squat', sets: [{ reps: 5, weight: 225 }] }] },
      ];
      localStorage.setItem('workout_logs', JSON.stringify(logs));

      const streaks = computeStreaks();
      assert(streaks.currentStreak === 1, `Gap breaks streak → currentStreak=1 (got ${streaks.currentStreak})`);
      assert(streaks.longestStreak === 2, `longestStreak=2 from 2+3 weeks ago (got ${streaks.longestStreak})`);
    }

    // ═══════════════════════════════════════════════════════════════
    // Phase 5 Tests: Dashboard Home
    // ═══════════════════════════════════════════════════════════════
    section('Phase 5: Dashboard Home');
    {
      seedData();
      Storage.setBodyweight(180);
      Storage.setGender('male');

      renderHome();
      const app = document.getElementById('app');

      // Strength card shown (bodyweight is set, has workout data)
      const strengthContainer = document.getElementById('strength-card-container');
      assert(strengthContainer !== null, 'Strength card container present when bodyweight set');
      assert(strengthContainer.querySelector('.strength-card-compact') !== null, 'Compact strength card rendered');

      // Streak values
      const streakValues = app.querySelectorAll('.streak-value');
      assert(streakValues.length >= 2, `Streak and week values displayed (got ${streakValues.length})`);

      // Recent activity
      const recentCards = app.querySelectorAll('.recent-card');
      assert(recentCards.length > 0, `Recent activity cards shown (got ${recentCards.length})`);
      assert(recentCards.length <= 3, 'At most 3 recent cards');

      // Template cards still present
      const templateCards = app.querySelectorAll('.card[data-template]');
      assert(templateCards.length >= 4, `Template cards present (got ${templateCards.length})`);

      // All header icons
      assert(document.getElementById('calendar-btn') !== null, 'Calendar button');
      assert(document.getElementById('history-btn') !== null, 'History button');
      assert(document.getElementById('data-btn') !== null, 'Settings button');

      // Create Workout button
      assert(document.getElementById('create-template-btn') !== null, 'Create Workout button exists');
    }

    section('Phase 5: Dashboard — no bodyweight hides strength card');
    {
      seedData();
      // Don't set bodyweight
      renderHome();
      const app = document.getElementById('app');
      const strengthContainer = document.getElementById('strength-card-container');
      assert(strengthContainer === null, 'Strength card hidden when no bodyweight');
    }

    // ═══════════════════════════════════════════════════════════════
    // Phase 7 Tests: Custom Templates
    // ═══════════════════════════════════════════════════════════════
    section('Phase 7: Custom template CRUD');
    {
      localStorage.clear();
      assert(Storage.getCustomTemplates().length === 0, 'Initially no custom templates');

      const tmpl = {
        id: 'custom_test1',
        name: 'Test Template',
        exercises: [{ exerciseId: 'squat', sets: 3, reps: '8-12', rpe: null, group: 'A' }]
      };
      Storage.saveCustomTemplate(tmpl);
      assert(Storage.getCustomTemplates().length === 1, 'saveCustomTemplate adds template');
      assert(Storage.getCustomTemplates()[0].name === 'Test Template', 'Template name correct');

      // Update
      tmpl.name = 'Updated Template';
      Storage.saveCustomTemplate(tmpl);
      assert(Storage.getCustomTemplates().length === 1, 'saveCustomTemplate updates existing');
      assert(Storage.getCustomTemplates()[0].name === 'Updated Template', 'Template name updated');

      // Delete
      Storage.deleteCustomTemplate('custom_test1');
      assert(Storage.getCustomTemplates().length === 0, 'deleteCustomTemplate removes template');
    }

    section('Phase 7: getAllTemplates merges');
    {
      localStorage.clear();
      Storage.saveCustomTemplate({ id: 'custom_x', name: 'Custom X', exercises: [] });
      const all = getAllTemplates();
      assert(all.length === WORKOUT_TEMPLATES.length + 1, `getAllTemplates = built-in + custom (got ${all.length})`);
      assert(all.some(t => t.id === 'custom_x'), 'Custom template in getAllTemplates');
      assert(all.some(t => t.id === 'day1'), 'Built-in template in getAllTemplates');
    }

    section('Phase 7: Export includes custom templates');
    {
      localStorage.clear();
      Storage.saveCustomTemplate({ id: 'custom_exp', name: 'Export Test', exercises: [] });
      const exported = Storage.exportAll();
      assert(Array.isArray(exported.custom_templates), 'exportAll includes custom_templates');
      assert(exported.custom_templates.length === 1, 'exported custom_templates has 1 entry');

      // Import
      localStorage.clear();
      Storage.importData(exported, 'replace');
      assert(Storage.getCustomTemplates().length === 1, 'importData replace restores custom templates');
      assert(Storage.getCustomTemplates()[0].id === 'custom_exp', 'Imported template id correct');
    }

    section('Phase 7: Template builder DOM');
    {
      localStorage.clear();
      let threw = false;
      try {
        renderTemplateBuilder();
      } catch (e) { threw = true; }
      assert(!threw, 'renderTemplateBuilder() does not throw');

      const app = document.getElementById('app');
      assert(document.getElementById('template-name') !== null, 'Template name input exists');
      assert(document.getElementById('exercise-search') !== null, 'Exercise search input exists');
      assert(document.getElementById('save-template-btn') !== null, 'Save button exists');
    }

    section('Phase 7: Template route');
    {
      const origHash = window.location.hash;
      let threw = false;
      try {
        window.location.hash = '#template/new';
        route();
      } catch (e) { threw = true; }
      assert(!threw, '#template/new route does not throw');
      window.location.hash = origHash;
    }

    // ═══════════════════════════════════════════════════════════════
    // Phase 8 Tests: Rest Timer
    // ═══════════════════════════════════════════════════════════════
    section('Phase 8: playTimerBeep');
    {
      let threw = false;
      try { playTimerBeep(); } catch (e) { threw = true; }
      assert(!threw, 'playTimerBeep does not throw');
    }

    section('Phase 8: Floating timer');
    {
      // Set up a fake rest timer
      window._restTimer = { endTime: Date.now() + 60000, exerciseName: 'Back Squat' };
      renderHome();
      showFloatingTimer();
      const banner = document.getElementById('floating-timer');
      assert(banner !== null, 'Floating timer banner appears when _restTimer active');
      assert(banner.textContent.includes('Back Squat'), 'Banner shows exercise name');

      // Clean up
      window._restTimer = null;
      removeFloatingTimer();
      if (window._floatingTimerInterval) clearInterval(window._floatingTimerInterval);
      const removed = document.getElementById('floating-timer');
      assert(removed === null, 'Banner removed when timer cleared');
    }

    // ═══════════════════════════════════════════════════════════════
    // Summary
    // ═══════════════════════════════════════════════════════════════
    const summary = document.getElementById('summary');
    const total = passed + failed;
    if (failed === 0) {
      summary.className = 'all-pass';
      summary.textContent = `All ${total} tests passed ✓`;
    } else {
      summary.className = 'has-fail';
      summary.textContent = `${failed} of ${total} tests failed ✗`;
    }

    // Show app element again for visual inspection
    document.getElementById('app').style.display = '';

    // Clean up
    localStorage.clear();
  </script>
</body>
</html>
